{% extends 'bridge/base.html' %}
{% comment "License" %}
% Copyright (c) 2018 ISP RAS (http://www.ispras.ru)
% Ivannikov Institute for System Programming of the Russian Academy of Sciences
%
% Licensed under the Apache License, Version 2.0 (the "License");
% you may not use this file except in compliance with the License.
% You may obtain a copy of the License at
%
%    http://www.apache.org/licenses/LICENSE-2.0
%
% Unless required by applicable law or agreed to in writing, software
% distributed under the License is distributed on an "AS IS" BASIS,
% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
% See the License for the specific language governing permissions and
% limitations under the License.
{% endcomment %}

{% load i18n %}

{% load humanize %}
{% load tz %}
{% load staticfiles %}
{% load compress %}

{% block head_block %}
    {# Jstree #}
    <link rel="stylesheet" href="{% static 'bridge/jstree/themes/default/style.min.css' %}">
    <script src="{% static 'bridge/jstree/jstree.min.js' %}"></script>

    <script type="application/javascript">
        const PAGE_URLS = {
            get_status: "{% url 'jobs:api-job-status' job.id %}",
            decide_job: "{% url 'jobs:api-decide' job.id %}",
            collapse_reports: "{% url 'jobs:api-collapse-reports' job.id %}",
            cancel_decision: "{% url 'jobs:api-cancel-decision' job.id %}",
            remove_job: "{% url 'jobs:api-remove-job' job.id %}",
            decision_results: "{% url 'jobs:decision-results' job.id %}",
            get_progress: "{% url 'jobs:progress' job.id %}",
            jobs_tree: "{% url 'jobs:tree' %}",
            prepare_decision: "{% url 'jobs:prepare-decision' job.id %}",
            has_children: "{% url 'jobs:api-has-children' job.id %}"
        };
    </script>

    {% compress js file job %}
        <script src="{% static 'jobs/js/jobFilesView.js' %}"></script>
        <script src="{% static 'jobs/js/versions.js' %}"></script>
        <script src="{% static 'jobs/js/jobPage.js' %}"></script>
    {% endcompress %}
{% endblock %}

{% block title %}{% trans 'Job' %} ({{ object.get_status_display }}){% endblock %}

{% block body_block %}
    <div class="ui grid">
        <div class="eight wide column">

            {# Job menu #}
            <div class="ui violet inverted menu top attached">

                <div class="ui dropdown item">
                    <div class="header">{% trans 'Job' %}</div><i class="dropdown icon"></i>
                    <div class="menu">
                        <a href="{% url 'jobs:download' object.id %}" class="item{% if not job_access.can_download %} disabled{% endif %}"><i class="download icon"></i> {% trans 'Download' %}</a>
                        <a href="{% url 'jobs:form' object.id 'edit' %}" class="item{% if not job_access.can_edit %} disabled{% endif %}"><i class="edit icon"></i> {% trans 'Edit' %}</a>
                        <a id="remove_job_btn" class="item{% if not job_access.can_delete %} disabled{% endif %}"><i class="trash icon"></i> {% trans 'Delete' %}</a>
                        <a href="{% url 'jobs:form' object.id 'copy' %}" class="item{% if not job_access.can_create %} disabled{% endif %}"><i class="copy icon"></i>{% trans 'Copy' %}</a>
                    </div>
                </div>

                <div class="ui dropdown item">
                    <div class="header">{% trans 'Decision' %}</div><i class="dropdown icon"></i>
                    <div class="menu">
                        <a id="decide_job_btn" class="item{% if not job_access.can_decide %} disabled{% endif %}"><i class="play icon"></i> {% trans 'Start' %}</a>
                        <a id="fast_decide_job_btn" class="item{% if not job_access.can_decide %} disabled{% endif %}"><i class="forward icon"></i> {% trans 'Start with default values' %}</a>
                        <a id="last_decide_job_btn" class="item{% if not job_access.can_decide_last %} disabled{% endif %}"><i class="redo icon"></i> {% trans 'Start with last configuration' %}</a>
                        <a id="stop_job_btn" class="item{% if not job_access.can_stop %} disabled{% endif %}"><i class="stop icon"></i> {% trans 'Stop' %}</a>
                    </div>
                </div>

                <div class="ui dropdown item">
                    <div class="header">{% trans 'Reports' %}</div><i class="dropdown icon"></i>
                    <div class="menu">
                        <a id="collapse_reports_btn" class="item{% if not job_access.can_collapse %} disabled{% endif %}"><i class="adjust icon"></i> {% trans 'Collapse' %}</a>
                        <a id="dfc_modal_show" class="item{% if not job_access.can_download_verifier_files %} disabled{% endif %}"><i class="download icon"></i> {% trans 'Download files for competition' %}</a>
                        <a id="clear_verifier_files_modal_show" class="item{% if not job_access.can_clear_verifier_files %} disabled{% endif %}" data-url="{% url 'reports:clear-verification-files' object.id %}"><i class="eraser icon"></i> {% trans 'Clear verifier input files' %}</a>
                    </div>
                </div>

                <div class="right menu">
                    <a id="job_autoupdate_btn" class="item" data-status="on">{% trans 'Stop page autorefresh' %}</a>
                </div>
            </div>

            {# Job data table #}
            <table class="ui selectable compact inverted violet table attached">
                <thead>
                    <tr>
                        <th class="center aligned" colspan="2">
                            <span class="ui olive header">{{ object.name }}{% if object.weight == '1' %} ({{ object.get_weight_display|lower }}){% endif %}</span>
                            {% if preset_changed %}<br>(<span style="color: #ff8d9e">{% trans 'Preset files for this job were changed' %}</span>){% endif %}
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr><th class="right aligned">{% trans 'Identifier' %}</th><td>{{ object.identifier }}</td></tr>
                    {% if object.parent %}
                        <tr><th class="right aligned">{% trans 'Parent identifier' %}</th><td>{{ object.parent.identifier }}</td></tr>
                    {% endif %}
                    {% if author %}
                        <tr>
                            <th class="right aligned">{% trans 'Created by' %}</th>
                            <td><a class="violet-link" href="{% url 'users:show-profile' author.pk %}">{{ author.get_full_name }}</a></td>
                        </tr>
                    {% endif %}
                    {% if parents %}
                        <tr>
                            <th class="right aligned">{% trans 'Parents' %}</th>
                            <td>
                                {% for parent in parents %}
                                    <div class="ui bulleted list"><div class="item">
                                    {% if parent.pk %}
                                        <a class="violet-link" href="{% url 'jobs:job' parent.pk %}">{{ parent.name }}</a>
                                    {% else %}
                                        <ins>{{ parent.name }}</ins>
                                    {% endif %}
                                {% endfor %}
                                {% for parent in parents %}
                                    </div></div>
                                {% endfor %}
                            </td>
                        </tr>
                    {% endif %}
                    {% if children %}
                        <tr>
                            <th class="right aligned">{% trans 'Children' %}</th>
                            <td>
                                <div class="ui bulleted list">
                                    {% for child in children %}
                                        <div class="item">
                                            {% if child.pk %}
                                                <a class="violet-link" href="{% url 'jobs:job' child.pk %}">{{ child.name }}</a>
                                            {% else %}
                                                <span><ins>{{ child.name }}</ins></span>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                    <tr>
                        <th class="right aligned">{% trans 'Last change' %}</th>
                        <td>
                            {% if user.data_format == 'hum' %}{{ last_version.change_date|naturaltime }}{% else %}{{ last_version.change_date }}{% endif %}
                            {% if last_version.change_author %}
                                (<a class="violet-link" href="{% url 'users:show-profile' last_version.change_author.pk %}">{{ last_version.change_author.get_full_name }}</a>)
                            {% endif %}
                            {% if last_version.comment|length %}
                                <p><span class="italic">{% trans 'Comment' %}:</span> <small>"{{ last_version.comment }}"</small></p>
                            {% endif %}
                        </td>
                    </tr>
                </tbody>
            </table>

            {# Files tree #}
            {% include 'jobs/viewJob/files.html' with data=files div_id='filestree_container' %}

            <br>

            {# User roles #}
            <div class="ui pink segment">
                <div class="ui top left attached pink label">{% trans 'Job access' %}</div>
                {% if user_roles.count %}
                    <ul>
                        {% for ur in user_roles %}
                            {% if ur.user == user %}
                                <li>{% trans 'Your role for the job' %}: {{ ur.get_role_display }}</li>
                            {% else %}
                                <li><a href="{% url 'users:show-profile' ur.user.id %}">{{ ur.user.get_full_name }}</a>: {{ ur.get_role_display }}</li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                {% endif %}
                <p>{% blocktrans with global_role=last_version.get_global_role_display %}Other users have role "{{ global_role }}" for this job{% endblocktrans %}</p>
            </div>

            {# Decision #}
            <div id="job_progress_container">
                {% include 'jobs/viewJob/decision.html' with data=decision %}
            </div>
            <input id="job_status_value" type="hidden" value="{{ object.status }}">

            {# Run history #}
            {% include 'jobs/viewJob/runHistory.html' with run_history=run_history %}

            {# Coverage #}
            {% include 'jobs/viewJob/coverage.html' with Coverage=Coverage %}
        </div>

        <div class="eight wide column">
            {# Job versions list #}
            {% if job_access.can_edit %}
                {% include 'jobs/viewJob/versions.html' with versions=versions %}
                <br>
            {% endif %}

            {# Data with verification results #}
            {% include reportdata.view.template with view=reportdata.view %}
            <br>
            <div id="job_data_div">{% include 'jobs/DecisionResults.html' %}</div>
        </div>
    </div>

    {# Data for javascript #}
    <input type="hidden" id="job_id" value="{{ object.id }}">
    <input type="hidden" id="job_version" value="{{ object.version }}">
    <input type="hidden" id="job_identifier" value="{{ object.identifier }}">

    <div hidden>
        <span id="jstree_view_label">{% trans 'View' %}</span>
        <span id="jstree_download_label">{% trans 'Download' %}</span>

        <span id="warn__decide_job">{% trans 'All existing reports of this job will be deleted' %}!</span>
        <span id="warn__remove_job">{% trans 'All versions and all data of this job will be deleted' %}!</span>
        <span id="warn__collapse">{% trans 'There is no reverse of this action' %}!</span>
        <span id="warn__has_children">{% trans 'The job has children, and all of them will be deleted' %}!</span>
        <span id="warn__clear_files">{% trans 'Files of verification reports will be deleted' %}!</span>
        <span id="warn__stop_decision">{% trans 'The job decision will be cancelled' %}!</span>
    </div>

    {# Popups #}
    {% if object.decision.error %}
        <div id="job_status_popup" class="ui inverted popup wide hidden">
            <div class="ui red header">{{ object.decision.error|safe }}</div>
        </div>
    {% endif %}

    {# Warning modal for job actions #}
    <div id="warn_modal" class="ui basic modal">
        <div class="ui icon header">
            <i class="warning sign icon"></i>
            {% trans 'Are you sure' %}?
        </div>
        <div class="content">
            <div class="ui center aligned grid"><p id="warn_text"></p></div>
        </div>
        <div class="actions">
            <div class="ui center aligned grid">
                <button id="warn_close_btn" type="button" class="ui blue basic inverted button">{% trans 'Cancel' %}</button>
                <button id="warn_confirm_btn" type="button" class="ui red basic inverted button">{% trans 'Confirm' %}</button>
            </div>
        </div>
    </div>

    {# Download files for competition modal #}
    {% if job_access.can_download_verifier_input %}
        <div id="dfc_modal" class="ui small dinamic modal">
            <div class="ui header">{% trans 'Choose filters' %}</div>
            <div class="content">
                <div class="ui grid">
                    <div class="six wide column">
                        {% if reportdata.totals and reportdata.totals.unsafes > 0 %}
                            <div class="ui checkbox">
                                <label for="dfc_unsafes">{% trans 'Unsafes' %}</label>
                                <input id="dfc_unsafes" type="checkbox">
                            </div>
                            <br>
                        {% endif %}
                        {% if reportdata.totals and reportdata.totals.safes > 0 %}
                            <div class="ui checkbox">
                                <label for="dfc_safes">{% trans 'Safes' %}</label>
                                <input id="dfc_safes" type="checkbox">
                            </div>
                            <br>
                        {% endif %}
                        {% if reportdata.totals and reportdata.totals.unknowns > 0 %}
                            <div class="ui checkbox">
                                <label for="dfc_unknowns">{% trans 'Unknowns' %}</label>
                                <input id="dfc_unknowns" type="checkbox">
                            </div>
                            <br>
                        {% endif %}
                    </div>
                    <div id="dfc_problems" class="ten wide column" style="display: none">
                        {% if reportdata.problems|length %}
                            <p><small>{% trans "If you don't choose unknowns' problems then all unknowns files will be downloaded" %}</small></p>
                        {% endif %}
                        {% for p in reportdata.problems %}
                            <div class="ui checkbox">
                                <label for="dfc_p_{{ p.id }}">{{ p.component }}/{{ p.problem }}</label>
                                <input id="dfc_p_{{ p.id }}" class="dfc-problem" type="checkbox" data-component="{{ p.component }}" data-problem="{{ p.problem }}">
                            </div>
                            <br>
                        {% endfor %}
                        <div class="ui checkbox">
                            <label for="dfc_p_null">{% trans 'Without marks' %}</label>
                            <input id="dfc_p_null" class="dfc-problem" type="checkbox" data-component="null" data-problem="null">
                        </div>
                        <br>
                    </div>
                    <div class="sixteen wide column right aligned">
                        <div class="ui buttons">
                            <button class="ui green button modal-confirm" data-url="{% url 'jobs:svcomp-files' job.id %}">{% trans 'Download' %}</button>
                            <button class="ui blue button modal-cancel">{% trans 'Cancel' %}</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <span id="error___dfc_notype" hidden>{% trans 'Choose at least one type of reports' %}</span>
    {% endif %}
    <span id="stop_autorefresh" hidden>{% trans 'Stop page autorefresh' %}</span>
    <span id="start_autorefresh" hidden>{% trans 'Start page autorefresh' %}</span>
    <span id="error__autoupdate_off" hidden>{% trans 'Page autoupdate is turned off' %}</span>
{% endblock %}
